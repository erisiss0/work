<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        .compact-select {
            color: transparent !important;
        }
        .compact-select option {
            color: #000 !important;
        }
        .selected-name {
            font-weight: 700;
            color: #dc2626 !important;
            margin-top: 3px;
            font-size: 1.125rem;
            line-height: 1.2;
        }
        select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .time-slot-morning { background-color: #f0fdf4; }
        .time-slot-afternoon { background-color: #fff7ed; }
        .time-slot-evening { background-color: #f5f3ff; }
        .compact-select {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            min-width: 6rem;
            transition: all 0.2s;
            appearance: none;
        }
        @media (max-width: 640px) {
            .selected-name {
                font-size: 1rem;
            }
            .table-container {
                overflow-x: auto;
                margin: 0 -1rem;
                width: calc(100% + 2rem);
            }
        }
    </style>
</head>
<body class="p-4 bg-gray-100">
    <div id="app">
        <div class="max-w-6xl mx-auto space-y-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-4">
                        <input type="date" v-model="startDateString" 
                               class="p-2 border rounded-md w-full max-w-[200px]">
                        <div class="flex gap-2">
                            <button @click="changeWeek(-1)" class="px-4 py-2 bg-gray-100 rounded-md">
                                ◀ 上一週
                            </button>
                            <button @click="changeWeek(1)" class="px-4 py-2 bg-gray-100 rounded-md">
                                下一週 ▶
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1">
                    <div class="flex gap-2">
                        <input type="text" v-model="newClient"
                               @keyup.enter="addClient"
                               class="w-32 p-2 border rounded-md"
                               placeholder="輸入客戶">
                        <button @click="addClient" class="px-3 py-2 bg-blue-500 text-white rounded-md text-sm">
                            新增
                        </button>
                        <button @click="showManager=!showManager" 
                                class="px-3 py-2 bg-gray-600 text-white rounded-md text-sm">
                            管理
                        </button>
                    </div>
                    
                    <div v-if="showManager" class="mt-2 p-4 bg-white rounded-md shadow">
                        <div class="mb-4 flex gap-2">
                            <button @click="exportClients" 
                                    class="px-3 py-2 bg-green-500 text-white rounded-md text-sm">
                                匯出客戶
                            </button>
                            <button @click="importClients" 
                                    class="px-3 py-2 bg-purple-500 text-white rounded-md text-sm">
                                匯入客戶
                            </button>
                            <input type="file" ref="fileInput" class="hidden" @change="handleFileUpload">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div v-for="(client, index) in clients" :key="index" 
                                 class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span>{{ client }}</span>
                                <button @click="removeClient(index)" class="text-red-500">×</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="w-full bg-white rounded-lg shadow">
                    <thead>
                        <tr>
                            <th class="p-2 bg-gray-100">時段</th>
                            <th v-for="(_, dayIndex) in 7" :key="dayIndex" 
                                class="p-2 bg-gray-100 min-w-[110px] text-sm">
                                週{{ ['一','二','三','四','五','六','日'][dayIndex] }}<br>
                                <span class="text-xs text-gray-600">{{ getDate(dayIndex) }}</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(timeSlot, tIndex) in timeSlots" :key="tIndex" 
                            :class="getTimeSlotClass(tIndex)">
                            <td class="p-2 font-medium text-center text-sm">{{ timeSlot }}</td>
                            <td v-for="(_, dIndex) in 7" :key="dIndex" class="p-2">
                                <div class="flex flex-col items-center">
                                    <select v-model="selections[tIndex][dIndex]"
                                            @change="handleSelectClose(tIndex, dIndex, $event)"
                                            class="compact-select">
                                        <option value=""></option>
                                        <option v-for="client in clients" 
                                                :value="client"
                                                class="text-sm">
                                            {{ client }}
                                        </option>
                                    </select>
                                    <div v-if="selections[tIndex][dIndex]" 
                                         class="selected-name">
                                        {{ selections[tIndex][dIndex] }}
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-lg font-semibold mb-2">備忘錄</h3>
                <textarea v-model="memo" 
                          class="w-full p-2 border rounded-md h-32"
                          placeholder="輸入注意事項..."
                          maxlength="2000"></textarea>
                <div class="text-sm text-gray-500 mt-1">{{ memo.length }}/2000 字</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                const STORAGE_KEYS = {
                    DATE: 'startDate',
                    CLIENTS: 'clients',
                    SELECTIONS: 'selections',
                    MEMO: 'memo'
                };

                const getMonday = (date) => {
                    const newDate = new Date(date);
                    const day = newDate.getDay();
                    const diff = day === 0 ? -6 : 1 - day;
                    newDate.setDate(newDate.getDate() + diff);
                    newDate.setHours(0, 0, 0, 0);
                    return newDate;
                };

                const loadFromStorage = (key, defaultValue) => {
                    try {
                        const stored = localStorage.getItem(key);
                        return stored ? JSON.parse(stored) : defaultValue;
                    } catch {
                        return defaultValue;
                    }
                };

                return {
                    startDate: loadFromStorage(STORAGE_KEYS.DATE, getMonday(new Date())),
                    newClient: '',
                    showManager: false,
                    timeSlots: [
                        '10:00～12:00',
                        '13:00～15:00',
                        '15:30～17:30',
                        '18:30～20:30',
                        '20:30～22:30'
                    ],
                    clients: loadFromStorage(STORAGE_KEYS.CLIENTS, []),
                    selections: loadFromStorage(STORAGE_KEYS.SELECTIONS, 
                        Array(5).fill().map(() => Array(7).fill(''))),
                    memo: loadFromStorage(STORAGE_KEYS.MEMO, ''),
                    storageKeys: STORAGE_KEYS
                }
            },
            computed: {
                startDateString: {
                    get() {
                        return this.startDate.toISOString().split('T')[0];
                    },
                    set(value) {
                        const newDate = new Date(value);
                        if (!isNaN(newDate.getTime())) {
                            this.startDate = this.getMonday(newDate);
                        }
                    }
                }
            },
            methods: {
                getMonday(date) {
                    const newDate = new Date(date);
                    const day = newDate.getDay();
                    const diff = day === 0 ? -6 : 1 - day;
                    newDate.setDate(newDate.getDate() + diff);
                    newDate.setHours(0, 0, 0, 0);
                    return newDate;
                },
                getDate(dayIndex) {
                    const date = new Date(this.startDate);
                    date.setDate(date.getDate() + dayIndex);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                },
                getTimeSlotClass(tIndex) {
                    return tIndex < 2 ? 'time-slot-morning' :
                           tIndex < 4 ? 'time-slot-afternoon' :
                           'time-slot-evening';
                },
                handleSelectClose(tIndex, dIndex, event) {
                    const select = event.target;
                    this.selections[tIndex][dIndex] = select.value;
                    this.$nextTick(() => select.blur());
                },
                addClient() {
                    const name = this.newClient.trim();
                    if (name && !this.clients.includes(name)) {
                        this.clients = [...this.clients, name];
                        this.newClient = '';
                    }
                },
                removeClient(index) {
                    this.clients = this.clients.filter((_, i) => i !== index);
                },
                changeWeek(offset) {
                    const newDate = new Date(this.startDate);
                    newDate.setDate(newDate.getDate() + offset * 7);
                    this.startDate = newDate;
                },
                exportClients() {
                    const data = JSON.stringify(this.clients, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `clients_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    a.remove();
                },
                importClients() {
                    this.$refs.fileInput.click();
                },
                async handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const importedClients = JSON.parse(text);
                        
                        if (!Array.isArray(importedClients) || 
                            importedClients.some(c => typeof c !== 'string')) {
                            throw new Error('檔案格式不正確');
                        }

                        this.clients = [...new Set([...this.clients, ...importedClients])];
                        alert(`成功匯入 ${importedClients.length} 個客戶`);
                    } catch (error) {
                        alert(`匯入失敗：${error.message}`);
                    } finally {
                        event.target.value = '';
                    }
                },
                saveToStorage(key, value) {
                    localStorage.setItem(key, JSON.stringify(value));
                }
            },
            watch: {
                startDate(newDate) {
                    this.saveToStorage(this.storageKeys.DATE, newDate);
                },
                clients(newVal) {
                    this.saveToStorage(this.storageKeys.CLIENTS, newVal);
                },
                selections: {
                    handler(newVal) {
                        this.saveToStorage(this.storageKeys.SELECTIONS, newVal);
                    },
                    deep: true
                },
                memo(newVal) {
                    this.saveToStorage(this.storageKeys.MEMO, newVal);
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
